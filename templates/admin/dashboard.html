<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickFix Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/timeline.css') }}">
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1>Campaign Tracking</h1>
                <p class="text-muted">Monitor and manage your security awareness campaigns.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="refreshDashboard()" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                    Refresh
                </button>
                <a href="{{ url_for('admin.export_csv', client=current_client) }}" class="btn btn-outline" id="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export CSV
                </a>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Date Range</label>
                    <div class="date-range-presets">
                        <button class="preset-btn" data-range="1">24h</button>
                        <button class="preset-btn" data-range="7">7d</button>
                        <button class="preset-btn active" data-range="30">30d</button>
                        <button class="preset-btn" data-range="90">90d</button>
                        <button class="preset-btn" data-range="custom">Custom</button>
                    </div>
                </div>
                <div class="filter-group" id="custom-date-range" style="display: none;">
                    <label>Custom Range</label>
                    <div class="flex gap-2">
                        <input type="date" id="start-date" class="form-control">
                        <span style="align-self: center;">to</span>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Interval</label>
                    <select id="interval-select" class="form-control form-select">
                        <option value="hour">Hourly</option>
                        <option value="day" selected>Daily</option>
                        <option value="week">Weekly</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Client</label>
                    <select id="client-filter" class="form-control form-select">
                        <option value="">All Clients</option>
                        {% for client in clients %}
                        <option value="{{ client }}" {% if client == current_client %}selected{% endif %}>{{ client }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Campaign</label>
                    <select id="campaign-filter" class="form-control form-select">
                        <option value="">All Campaigns</option>
                        {% for campaign in campaigns %}
                        <option value="{{ campaign.id }}">{{ campaign.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-row" style="margin-top: var(--spacing-md);">
                <div class="filter-group">
                    <label>Event Types</label>
                    <div class="event-type-filters">
                        <span class="event-type-chip page-view active" data-type="PAGE_VIEW">
                            <span class="legend-color page-view"></span> Page Views
                        </span>
                        <span class="event-type-chip button-click active" data-type="BUTTON_CLICK">
                            <span class="legend-color button-click"></span> Clicks
                        </span>
                        <span class="event-type-chip payload-executed active" data-type="PAYLOAD_EXECUTED">
                            <span class="legend-color payload-executed"></span> Executions
                        </span>
                        <span class="event-type-chip training active" data-type="TRAINING_COMPLETED,TRAINING_ACKNOWLEDGED,TRAINING_VIEWED">
                            <span class="legend-color training"></span> Training
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="timeline-container" id="timeline-container">
            <div class="timeline-header">
                <h3 class="timeline-title">Event Timeline</h3>
                <div class="timeline-controls">
                    <span id="timeline-range-label" class="text-muted" style="font-size: 0.875rem;"></span>
                </div>
            </div>
            <div class="timeline-wrapper">
                <div class="timeline-y-axis" id="timeline-y-axis">
                    <!-- Y-axis labels will be rendered by JavaScript -->
                </div>
                <div class="timeline-chart" id="timeline-chart">
                    <!-- Bars will be rendered by JavaScript -->
                </div>
            </div>
            <div class="timeline-labels" id="timeline-labels">
                <!-- Labels will be rendered by JavaScript -->
            </div>
            <div class="timeline-legend">
                <div class="legend-item" data-type="PAGE_VIEW">
                    <span class="legend-color page-view"></span>
                    <span>Page Views</span>
                </div>
                <div class="legend-item" data-type="BUTTON_CLICK">
                    <span class="legend-color button-click"></span>
                    <span>Clicks</span>
                </div>
                <div class="legend-item" data-type="PAYLOAD_EXECUTED">
                    <span class="legend-color payload-executed"></span>
                    <span>Executions</span>
                </div>
                <div class="legend-item" data-type="TRAINING">
                    <span class="legend-color training"></span>
                    <span>Training</span>
                </div>
            </div>
            <div class="selection-info" id="selection-info">
                <span id="selection-text"></span>
                <span class="clear-selection" onclick="clearTimelineSelection()">Clear selection</span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-views">{{ stats.total_views }}</div>
                <div class="stat-label">Page Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-clicks" style="color: var(--color-warning);">{{ stats.total_clicks }}</div>
                <div class="stat-label">Clicks (Copied)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-executions" style="color: var(--color-danger);">{{ stats.total_executions }}</div>
                <div class="stat-label">Executions (Compromised)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-training" style="color: var(--color-success);">{{ stats.total_training_completed }}</div>
                <div class="stat-label">Training Completed</div>
            </div>
        </div>

        <!-- Campaign Creator -->
        <div class="card" id="new-campaign-card">
            <h3 class="mb-4">Launch New Campaign</h3>
            <form action="{{ url_for('admin.create_campaign') }}" method="POST" class="flex flex-col gap-4">
                <div class="flex gap-4" style="flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 250px;">
                        <label class="form-label">Campaign Name</label>
                        <input type="text" name="name" required placeholder="e.g. Q3 Phishing Simulation" class="form-control">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label">Client Name</label>
                        <input type="text" name="client" placeholder="e.g. Acme Corp" list="clients-list" class="form-control">
                        <datalist id="clients-list">
                            {% for client in clients %}
                            <option value="{{ client }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
                
                <div class="flex gap-4" style="flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label">Scenario Template</label>
                        <select name="scenario" required class="form-control form-select">
                            {% for scenario in scenarios %}
                                <option value="{{ scenario.id }}">{{ scenario.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label">Trap Template</label>
                        <select name="trap_slug" class="form-control form-select">
                            <option value="">Default (None/Embedded)</option>
                            {% for trap in traps %}
                                <option value="{{ trap.id }}">{{ trap.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <label class="form-label">Stealth Slug (URL)</label>
                        <div class="flex items-center" style="border: 1px solid var(--color-border); border-radius: var(--radius-md); background-color: #f8fafc;">
                            <span style="padding: 0.5rem 0.75rem; color: var(--color-text-muted); font-size: 0.875rem; border-right: 1px solid var(--color-border);">/s/</span>
                            <input type="text" name="slug" placeholder="meeting-join-v2" pattern="[a-zA-Z0-9\-\_\.]+" title="Alphanumeric, dots, dashes, and underscores only" class="form-control" style="border: none; background: transparent; box-shadow: none;">
                        </div>
                    </div>
                </div>
                
                <div class="text-right mt-4">
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Create Campaign
                    </button>
                </div>
            </form>
        </div>

        <!-- Client Filter -->
        <div class="flex items-center gap-4 mb-4">
            <span class="font-bold text-muted">Filter by Client:</span>
            <form method="get" action="{{ url_for('admin.admin_dashboard') }}" style="margin: 0;">
                <select name="client" onchange="this.form.submit()" class="form-control form-select" style="padding-top: 0.25rem; padding-bottom: 0.25rem; min-width: 200px;">
                    <option value="">All Clients</option>
                    {% for client in clients %}
                    <option value="{{ client }}" {% if client == current_client %}selected{% endif %}>{{ client }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <h2 class="mb-4" id="active-campaigns">Active Campaigns</h2>
        <div class="table-container mb-8">
            <table class="table">
                <thead>
                    <tr>
                        <th>Campaign Name</th>
                        <th>Client</th>
                        <th>Scenario</th>
                        <th>Trap</th>
                        <th>Slug (Stealth URL)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for campaign in campaigns %}
                    <tr>
                        <td>
                            <div class="font-bold">{{ campaign.name }}</div>
                            <div style="font-size: 0.75rem; color: var(--color-text-muted);">Created: {{ campaign.created_at.strftime('%Y-%m-%d') }}</div>
                        </td>
                        <td><span class="badge badge-gray">{{ campaign.client_name or 'Default' }}</span></td>
                        <td>{{ campaign.scenario }}</td>
                        <td><span class="text-muted">{{ campaign.trap_slug or 'Default' }}</span></td>
                        <td>
                            {% if campaign.slug %}
                                <div class="flex items-center gap-2">
                                    <code>/s/{{ campaign.slug }}</code>
                                    <button onclick="copyLink({{ (request.host_url ~ 's/' ~ campaign.slug)|tojson }})" class="btn btn-sm btn-outline" title="Copy Link">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    </button>
                                </div>
                            {% else %}
                                <span class="text-muted italic">Legacy</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <a href="{{ url_for('admin.campaign_dashboard', campaign_id=campaign.id) }}" class="btn btn-sm btn-outline">Stats</a>
                                <form action="{{ url_for('admin.delete_campaign', campaign_id=campaign.id) }}" method="POST" style="display: inline;" onsubmit="return ClickFixUI.confirmSubmit(event, 'Are you sure you want to delete this campaign? This action cannot be undone.');">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-8">No campaigns found. Create one above to get started.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="mb-4">Recent Activity Log</h2>
        <div class="table-container">
            <table class="table" id="events-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User ID</th>
                        <th>Campaign</th>
                        <th>Event</th>
                        <th>Platform</th>
                        <th>IP Address</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td style="white-space: nowrap;">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td><code>{{ event.user_id }}</code></td>
                        <td>{{ event.campaign.name if event.campaign else 'Unknown' }}</td>
                        <td>
                            {% if event.event_type == 'PAGE_VIEW' %}
                                <span class="badge badge-blue">Viewed Page</span>
                            {% elif event.event_type == 'BUTTON_CLICK' %}
                                <span class="badge badge-amber">Clicked Fix</span>
                            {% elif event.event_type == 'PAYLOAD_EXECUTED' %}
                                <span class="badge badge-red">EXECUTED</span>
                            {% elif event.event_type == 'TRAINING_VIEWED' %}
                                <span class="badge badge-gray">Training Started</span>
                            {% elif event.event_type == 'TRAINING_COMPLETED' %}
                                <span class="badge badge-green">Training Viewed All</span>
                            {% elif event.event_type == 'TRAINING_ACKNOWLEDGED' %}
                                <span class="badge badge-green" style="background-color: #15803d;">Training Acknowledged</span>
                            {% else %}
                                {{ event.event_type }}
                            {% endif %}
                        </td>
                        <td>{{ event.platform }}</td>
                        <td>{{ event.source_ip }}</td>
                        <td>
                            {% if event.hostname %}
                                <div style="font-size: 0.85em;">
                                    <div><strong>Host:</strong> {{ event.hostname }}</div>
                                    <div><strong>User:</strong> {{ event.username }}</div>
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-8">No events recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/timeline.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard({
                currentClient: {{ (current_client or '')|tojson }},
                apiEndpoints: {
                    timeline: {{ url_for('admin.api_timeline')|tojson }},
                    stats: {{ url_for('admin.api_stats')|tojson }},
                    events: {{ url_for('admin.api_events')|tojson }}
                }
            });
        });
    </script>
    {% include "components/admin_nav.html" %}
</body>
</html>